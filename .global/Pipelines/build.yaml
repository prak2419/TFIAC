parameters:
  - name: 'environment'
    type: string
    default: dev
    values:
    - dev
    - prod
  
variables:
  - ${{ if eq(parameters.environment, 'dev') }}:
    - template: dev-variables.yaml
  - ${{ if eq(parameters.environment, 'prod') }}:
    - template: prod-variables.yaml

#Trigger from branch
trigger:
  branches:
    include:
      - prod
      - dev0

jobs:
  - job: 'BuildModule_vnetdemo'
    pool: $(poolName)
    displayName: 'Build Packages'
    workspace:
      clean: all
    steps:
    - checkout: self
      persistCredentials: true
      clean: true
      fetchDepth: true

    - task: CopyFiles@2
      displayName: 'Filter folders'
      inputs:
        Contents: |
          **
          !**\.git\**
          !**\.terraform\**
        targetFolder: $(Build.ArtifactStagingDirectory)
    
    - task: AzureCLI@2
      displayName: 'Azure CLI - Promote Service Principal'
      inputs:
        azureSubscription: $(serviceConnection)
        scriptType: ps
        scriptLocation: inlineScript
        inlineScript: |
          Write-Host "##vso[task.setvariable variable=CLIENT_ID]$($env:servicePrincipalId)"

          Write-Host "##vso[task.setvariable variable=CLIENT_SECRET]$($env:servicePrincipalKey)"

          Write-Host "##vso[task.setvariable variable=TENANT_ID]$($env:tenantId)"
        addSpnToEnvironment: true
    
    - task: AzurePowerShell@5
      inputs:
        azureSubscription: $(serviceConnection)
        ConnectedServiceNameARM: $(serviceConnection)
        ScriptType: 'InlineScript'
        azurePowerShellVersion: 'LatestVersion'
        Inline: |
          $buildId = "$(Build.BuildId)"
          $timestamp = Get-Date -Format "yyyy/MM/dd_HH:mm:ss"
          $buildNumber = "$(Build.BuildNumber)"
          $azureAplicationId ="$(CLIENT_ID)"
          $azureTenantId= "$(TENANT_ID)"
          $azurePassword = ConvertTo-SecureString "$(CLIENT_SECRET)" -AsPlainText -Force
          $psCred = New-Object System.Management.Automation.PSCredential($azureAplicationId , $azurePassword)
          Connect-AzAccount -Credential $psCred -TenantId $azureTenantId  -ServicePrincipal
          $storageAccountName = "$(backendStorageAccountName)"
          $resourceGroupName = "$(backendResourceGroupName)"
          $containerName = "$(buildContainerName)"
          $blobName = "buildId.csv"
          $storageAccount = Get-AzStorageAccount -ResourceGroupName $resourceGroupName -Name $storageAccountName
          $storageContext = $storageAccount.Context
          $container = Get-AzStorageContainer -Name $containerName -Context $storageContext
          $blob = Get-AzStorageBlobContent -Container $containerName -Context $storageContext -Blob $blobName -Destination .\$blobName -ErrorAction SilentlyContinue
          $arr = @()
          $psobj = [PSCustomobject]@{
              Buildid = $buildId
              Buildnumber = $buildNumber
              Timestamp = $timestamp
          }
          $arr += $psobj
          $arr | Export-Csv -Path .\$blobName -NoTypeInformation -Append -Force
          Set-AzStorageBlobContent -Container $containerName -File .\$blobName -Blob $blobName -Context $storageContext -Force
          Remove-Item -Path .\$blobName -Force
        workingDirectory: '$(System.ArtifactsDirectory)'
    
    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@1
      displayName: 'Install Terraform latest'
      inputs:
        terraformVersion: 'latest'

    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV4@4
      displayName: 'Terraform : azurerm - Init'
      inputs:
        backendServiceArm: SharedResources
        backendAzureRmResourceGroupName: ${{ parameters.backendResourceGroupName }}
        backendAzureRmStorageAccountName: ${{ parameters.backendStorageAccountName }}
        backendAzureRmContainerName: ${{ parameters.backendContainerName }}
        backendAzureRmKey: '${{ parameters.moduleName }}-${{ parameters.environment }}.tfstate'
        workingDirectory: '$(System.ArtifactsDirectory)\${{ parameters.environment }}'
            
    - powershell: |
        terraform workspace new ${{ parameters.environment }}
        terraform workspace select ${{ parameters.environment }}
      displayName: 'Create and Set the Terraform workspace'
      workingDirectory: '$(System.ArtifactsDirectory)\${{ parameters.environment }}'

    - task: ms-devlabs.custom-terraform-tasks.custom-terraform-release-task.TerraformTaskV4@4
      displayName: 'Terraform : azurerm - Plan'
      inputs:
        provider: azurerm
        command: 'plan'
        workingDirectory: '$(System.ArtifactsDirectory)\${{ parameters.environment }}'
        commandOptions: '-var-file=${{ parameters.environment }}.auto.tfvars -out=${{ parameters.environment }}-tfplan'
        environmentServiceNameAzureRM: SharedResources
        
            #- powershell: |
            #    $copydir = "C:\dev\tfstate"
            #    if (!(Test-Path $copydir)) { New-Item -ItemType Directory -Force -Path $copydir }
            #    $date = Get-Date -format '%y%m%d%H%M%S'
            #    $buildversion = "${Build.BuildNumber}"
            #    $appendString = "$date-$buildversion"
            #    Copy-Item $(System.ArtifactsDirectory)\Demo\${{ parameters.environment }}\${{ parameters.environment }}-tfplan C:\dev\tfstate\$appendString-${{ parameters.environment }}-tfplan
            #  displayName: 'Copy Terraform plan to remote folder'
            #  workingDirectory: '$(System.ArtifactsDirectory)\Demo\${{ parameters.environment }}'
    - powershell: |
        terraform show $(System.ArtifactsDirectory)\${{ parameters.environment }}\${{ parameters.environment }}-tfplan > ${{ parameters.environment }}.ansi
      displayName: 'Create and Set the Terraform workspace'
      workingDirectory: '$(System.ArtifactsDirectory)\${{ parameters.environment }}'

    - task: AzureFileCopy@4
      inputs:
        SourcePath: $(System.ArtifactsDirectory)\${{ parameters.environment }}\${{ parameters.environment }}.ansi
        azureSubscription: 'SharedResources' 
        Destination: 'AzureBlob'
        resourceGroup: ${{ parameters.backendResourceGroupName }}
        storage: ${{ parameters.backendStorageAccountName }} 
        ContainerName: ${{ parameters.backendContainerName }}
        BlobPrefix: "$(Build.BuildNumber)_${{ parameters.moduleName }}-${{ parameters.environment }}.ansi"
              

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifacts'
      inputs:
        pathtoPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: '$(artifactName)'
        publishLocation: 'Container'